lab_name: NSFW_PurpleLab
description: >
  Purple team simulation for testing NSFW (Net Sharing Fileless Wiperware),
  a stealth, polymorphic, fileless Windows malware framework. Lab includes:
  - Fileless reflective DLL injection
  - LOLBins execution (rundll32, regsvr32, mshta)
  - AES-XTS DiskCryptor-based encryption
  - Polymorphic code mutation via Azure OpenAI (CV032 / GUMI agent)
  - ELK + Sigma + Sysmon telemetry
  - Azure DevOps pipeline + Azure Function deployment

infrastructure:
  platform: Hyper-V
  base_image: "Windows 11 Pro Eval"
  network:
    - name: NSFW-LAN
      type: internal
      ip_range: "192.168.66.0/24"

vms:
  - name: Target-Win11
    role: victim
    image: windows-11-pro
    memory: 8GB
    cpus: 4
    ip: 192.168.66.10
    users:
      - username: attacker
        password: "P@ssw0rd123!"
    tools:
      preinstalled:
        - PowerShell v7
        - Git
        - SysinternalsSuite
        - Visual C++ Redistributables
        - Donut (shellcode gen)
      scripts:
        - name: Enable-SecurityLogs
          script: |
            auditpol /set /category:* /success:enable /failure:enable
        - name: Install-Sysmon
          script: |
            iwr -Uri https://download.sysinternals.com/files/Sysmon.zip -OutFile sysmon.zip
            Expand-Archive sysmon.zip -DestinationPath C:\Tools\Sysmon
            .\C:\Tools\Sysmon\Sysmon.exe -accepteula -i C:\Tools\Sysmon\sysmonconfig.xml
    defenders:
      microsoft_defender:
        real_time_protection: true
        exclusions:
          - "C:\\payloads"
          - "C:\\Tools"

  - name: Logger-ELK
    role: siem
    image: ubuntu-22.04
    memory: 6GB
    cpus: 2
    ip: 192.168.66.20
    tools:
      install:
        - elasticsearch
        - kibana
        - logstash
        - filebeat
        - suricata
    config_scripts:
      - name: Load-Sigma
        script: |
          git clone https://github.com/SigmaHQ/sigma.git /opt/sigma
          sudo systemctl enable elasticsearch logstash kibana

  - name: AzureAI-CV032
    role: ai_dev_agent
    image: ubuntu-22.04
    memory: 4GB
    cpus: 2
    ip: 192.168.66.30
    tools:
      install:
        - azure-cli
        - python3
        - pip
        - git
      scripts:
        - name: Setup-CV032
          script: |
            pip install openai azure-identity
            git clone https://github.com/YourRepo/NSFW /opt/NSFW
            echo "
            from openai import AzureOpenAI
            def generate_mutated_payload(prompt):
                response = AzureOpenAI.ChatCompletion.create(
                  engine='cv032-deploy',
                  messages=[{'role': 'system', 'content': 'Polymorphic fileless malware dev agent.'},
                            {'role': 'user', 'content': prompt}],
                  temperature=1.2,
                  max_tokens=1200
                )
                return response['choices'][0]['message']['content']
            " > /opt/NSFW/ai/mutator.py

        - name: Auto-Deploy-Payload
          script: |
            cd /opt/NSFW/ai
            python3 mutate_and_build.py
            az functionapp deployment source config-zip -g NSFW-RG -n NSFWFunctionApp --src /opt/NSFW/build/reflective_dll_payload.zip

shared_folders:
  - name: NSFW-Source
    path_host: ./NSFW/
    path_guest: C:\payloads
    mount_to:
      - Target-Win11

monitoring:
  - type: Sysmon
    enabled: true
    target: Target-Win11
  - type: Sigma
    enabled: true
    location: /opt/sigma
    siem_target: Logger-ELK
  - type: LOLBins
    custom:
      include_bins:
        - rundll32.exe
        - regsvr32.exe
        - mshta.exe

automation:
  pipeline:
    tool: Azure DevOps
    trigger: "push"
    stages:
      - name: Build_Payload
        agent: AzureAI-CV032
        script: |
          python3 /opt/NSFW/ai/mutator.py --input encryptor_template.cpp --output encryptor_mutated.cpp
          cl.exe /LD encryptor_mutated.cpp /Fe:encryptor.dll
      - name: Test_VM_Deploy
        target: Target-Win11
        script: |
          rundll32.exe C:\payloads\encryptor.dll,EntryPoint
      - name: Push_to_Function
        target: AzureAI-CV032
        script: |
          az functionapp deployment source config-zip -g NSFW-RG -n NSFWFunctionApp --src /opt/NSFW/payloads/encryptor.dll

tags:
  - fileless
  - polymorphic
  - diskcryptor
  - reflective-dll
  - ai-agent
  - lolbins
  - mitre-attack
